{
  "$schema": "https://schemas.sing-box.com/config.schema.json",
  "dns": {
    "servers": [
      // ==== 广告拦截专用DNS ====
      {
        "tag": "dns_adblock",
        "address": "https://dns.adguard.com/dns-query",
        "detour": "direct",
        "strategy": "ipv4_only",
        "rules": [
          {"rule_set": ["geosite-ads"], "server": "rcode://success"},
          {"domain_suffix": [".ad.", ".track."], "disable_cache": true}
        ]
      },
      // ==== 低延迟DNS集群 ====
      {
        "tag": "dns_fast",
        "address": "quic://dns.cloudflare.com",
        "detour": "⚡ 低延迟优选",
        "strategy": "prefer_ipv6",
        "dialer_options": {
          "tcp_fast_open": true,
          "udp_fragment": true
        }
      },
      // ==== 国内DNS ====
      {
        "tag": "dns_cn",
        "address": "https://doh.pub/dns-query",
        "detour": "direct"
      }
    ],
    "rules": [
      // 强制拦截广告
      {
        "rule_set": ["geosite-ads"],
        "server": "rcode://success",
        "disable_cache": true
      },
      // 流媒体加速
      {
        "rule_set": ["geosite-streaming"],
        "server": "dns_fast",
        "strategy": "prefer_ipv6"
      },
      // 国内域名
      {
        "geosite": ["cn"],
        "server": "dns_cn"
      }
    ],
    "final": "dns_fast",
    "independent_cache": true,
    "cache_strategy": "enforce"
  },

  "outbounds": [
    // ========== 原始策略组（完全保留） ==========
    {"tag": "🚀 默认代理", "type": "selector", "outbounds": ["🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择", "♻️ 自动选择"]},
    {"tag": "🧠 AI", "type": "selector", "outbounds": ["🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动"]},
    {"tag": "📹 YouTube", "type": "selector", "outbounds": ["🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "🎬 Emby", "type": "selector", "outbounds": ["🇭🇰 香港手动"]},
    {"tag": "🍀 Google", "type": "selector", "outbounds": ["🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "👨‍💻 Github", "type": "selector", "outbounds": ["🇯🇵 日本手动", "🇭🇰 香港手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "📲 Telegram", "type": "selector", "outbounds": ["🇸🇬 狮城手动", "🇭🇰 香港手动", "🇯🇵 日本手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "🎵 TikTok", "type": "selector", "outbounds": ["🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "🎥 Netflix", "type": "selector", "outbounds": ["🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "💶 PayPal", "type": "selector", "outbounds": ["🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "🎮 Steam", "type": "selector", "outbounds": ["🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "🪟 Microsoft", "type": "selector", "outbounds": ["🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "🐬 OneDrive", "type": "selector", "outbounds": ["🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择"]},
    {"tag": "🍏 Apple", "type": "selector", "outbounds": ["🎯 全球直连", "🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动"]},
    {"tag": "🐠 漏网之鱼", "type": "selector", "outbounds": ["🚀 默认代理", "🎯 全球直连"]},
    {"tag": "🇭🇰 香港手动", "type": "selector", "outbounds": ["{all}"], "filter": [{"action": "include", "keywords": ["🇭🇰|HK|hk|香港|港|HongKong"]}, {"action": "exclude", "keywords": ["免费"]}]},
    {"tag": "🇯🇵 日本手动", "type": "selector", "outbounds": ["{all}"], "filter": [{"action": "include", "keywords": ["🇯🇵|JP|jp|日本|日|Japan"]}, {"action": "exclude", "keywords": ["免费"]}]},
    {"tag": "🇸🇬 狮城手动", "type": "selector", "outbounds": ["{all}"], "filter": [{"action": "include", "keywords": ["新加坡|坡|狮城|SG|Singapore"]}, {"action": "exclude", "keywords": ["免费"]}]},
    {"tag": "🇺🇲 美国手动", "type": "selector", "outbounds": ["{all}"], "filter": [{"action": "include", "keywords": ["🇺🇸|US|us|美国|美|United States"]}, {"action": "exclude", "keywords": ["AUS|RUS|免费"]}]},
    {"tag": "🐸 手动选择", "type": "selector", "outbounds": ["{all}"], "filter": [{"action": "exclude", "keywords": ["网站|流量|地址|剩余|过期|免费|时间|有效|Traffic|ExpireDate|GB|Expire Date"]}]},
    {"tag": "♻️ 自动选择", "type": "urltest", "outbounds": ["{all}"], "filter": [{"action": "exclude", "keywords": ["官网|到期时间|剩余|流量|套餐|免费|订阅|全球直连|GB|Expire Date|Traffic|ExpireDate"]}], "interval": "10m", "tolerance": 100},
    {"tag": "🍃 延迟辅助", "type": "urltest", "outbounds": ["🚀 默认代理", "🎯 全球直连"]},
    {"tag": "GLOBAL", "type": "selector", "outbounds": ["🚀 默认代理", "🧠 AI", "📹 YouTube", "🎬 Emby", "🍀 Google", "👨‍💻 Github", "📲 Telegram", "🎵 TikTok", "🎥 Netflix", "💶 PayPal", "🎮 Steam", "🪟 Microsoft", "🐬 OneDrive", "🍏 Apple", "🐠 漏网之鱼", "🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动", "🇺🇲 美国手动", "🐸 手动选择", "♻️ 自动选择", "🍃 延迟辅助", "🎯 全球直连"]},
    {"tag": "🎯 全球直连", "type": "direct"},
    {"tag": "block", "type": "block"}
  ],
  "route": {
    "rules": [
      {"action": "sniff", "sniffer": ["http", "tls", "quic", "dns"]},
      {"inbound": "dns-in", "action": "hijack-dns"},
      {"ip_is_private": true, "outbound": "🎯 全球直连"},
      {"clash_mode": "direct", "outbound": "🎯 全球直连"},
      {"clash_mode": "global", "outbound": "GLOBAL"},
      {"rule_set": "geosite-category-ads-all", "outbound": "block"},
      {"domain_suffix": [
        "doubleclick.net", "googlesyndication.com", "googletagmanager.com", 
        "googletagservices.com", "google-analytics.com", "googleadservices.com",
        "facebook.com", "fbcdn.net", "fb.com", "fbsbx.com",
        "cdninstagram.com", "instagram.com",
        "twitter.com", "twimg.com",
        "tiktok.com", "tiktokcdn.com", "tiktokv.com", "byteoversea.com", "bytedance.com",
        "amplitude.com", "optimizely.com", "krxd.net", "scorecardresearch.com", "quantserve.com"
      ], "outbound": "block"},
      {"domain_keyword": [
        "ads", "ad", "tracking", "analytics", "pixel", "beacon", 
        "doubleclick", "googlesyndication", "googletagmanager", "googletagservices", "google-analytics"
      ], "outbound": "block"},
      {"ip_cidr": [
        "172.217.0.0/16", "172.217.160.0/20", "172.217.160.1/32",
        "172.217.160.2/31", "172.217.160.4/30", "172.217.160.8/29",
        "172.217.160.16/28", "172.217.160.32/27", "172.217.160.64/26",
        "172.217.160.128/25", "172.217.161.0/24", "172.217.162.0/23",
        "172.217.164.0/22", "172.217.168.0/21", "172.217.176.0/20",
        "172.217.192.0/18"
      ], "outbound": "block"},
      {"rule_set": "geosite-youtube", "outbound": "📹 YouTube"},
      {"rule_set": "geosite-emby", "outbound": "🎬 Emby"},
      {"domain_suffix": [
        "emby.media", "embyaccess.com", "jellyfin.org", 
        "jellyfin.media", "jellyfin.tv", "jellyfin.dev", 
        "jellyfin.exp", "jellyfin.net", "emby.tv", "emby.app",
        "emby.server", "emby.client", "emby.sync", "emby.connect",
        "emby.theater", "emby.player", "emby.mobile", "emby.android",
        "emby.ios", "emby.windows", "emby.linux", "emby.macos",
        "emby.web", "emby.dashboard", "emby.api", "emby.rest"
      ], "outbound": "🎬 Emby"},
      {"rule_set": "geosite-ai", "outbound": "🧠 AI"},
      {"rule_set": "geosite-google", "outbound": "🍀 Google"},
      {"rule_set": "geosite-github", "outbound": "👨‍💻 Github"},
      {"rule_set": "geosite-onedrive", "outbound": "🐬 OneDrive"},
      {"rule_set": "geosite-microsoft", "outbound": "🪟 Microsoft"},
      {"rule_set": "geosite-apple", "outbound": "🍏 Apple"},
      {"rule_set": "geosite-telegram", "outbound": "📲 Telegram"},
      {"rule_set": "geosite-tiktok", "outbound": "🎵 TikTok"},
      {"rule_set": "geosite-netflix", "outbound": "🎥 Netflix"},
      {"rule_set": "geosite-paypal", "outbound": "💶 PayPal"},
      {"rule_set": "geosite-steamcn", "outbound": "🎯 全球直连"},
      {"rule_set": "geosite-steam", "outbound": "🎮 Steam"},
      {"rule_set": "geosite-!cn", "outbound": "🚀 默认代理"},
      {"rule_set": "geosite-cn", "outbound": "🎯 全球直连"},
      {"rule_set": "geoip-google", "outbound": "🍀 Google"},
      {"rule_set": "geoip-apple", "outbound": "🍏 Apple"},
      {"rule_set": "geoip-telegram", "outbound": "📲 Telegram"},
      {"rule_set": "geoip-netflix", "outbound": "🎥 Netflix"},
      {"rule_set": "geoip-cn", "outbound": "🎯 全球直连"}
    ],

    // ========== 新增优化组 ==========
    // 1. 低延迟优选组
    {
      "tag": "⚡ 低延迟优选",
      "type": "urltest",
      "outbounds": ["🇭🇰 香港手动", "🇯🇵 日本手动", "🇸🇬 狮城手动"],
      "interval": "3m",
      "tolerance": 50,
      "dialer_options": {
        "tcp_keep_alive": 10,
        "tcp_no_delay": true,
        "tcp_fast_open": true
      },
      "transport": {
        "type": "ws",
        "path": "/lowlatency",
        "headers": {
          "X-Edge-Type": "CDN"
        }
      }
    },
    // 2. 广告拦截出口
    {
      "tag": "🛑 广告拦截",
      "type": "block",
      "override": {
        "response": {
          "status_code": 444,
          "body": "Blocked by Momo-AdFilter"
        }
      }
    }
  ],

  "route": {
    "rules": [
      // ====== 广告拦截规则 ======
      {
        "rule_set": ["geosite-ads", "geoip-ads"],
        "outbound": "🛑 广告拦截",
        "disable_cache": true
      },
      {
        "protocol": ["quic", "http/2"],
        "domain_keyword": ["adservice", "tracking"],
        "outbound": "🛑 广告拦截"
      },

      // ====== 低延迟路由 ======
      {
        "rule_set": ["geosite-streaming"],
        "outbound": "⚡ 低延迟优选",
        "speed_limit": "20mbps",
        "qos": {
          "priority": 1,
          "dscp": "AF41"
        }
      },
      {
        "rule_set": ["geosite-gaming"],
        "outbound": "⚡ 低延迟优选",
        "qos": {
          "priority": 0,
          "dscp": "CS6"
        }
      },

      // ====== 保留原始规则 ======
      {"geoip": ["cn"], "outbound": "🎯 全球直连"},
      {"geosite": ["cn"], "outbound": "🎯 全球直连"},
      {"domain_suffix": ["msftconnecttest.com"], "outbound": "direct"}
    ],

    "rule_set": [
      // ====== 广告规则集 ======
      {
        "tag": "geosite-ads",
        "type": "remote",
        "format": "binary",
        "url": "https://fastly.jsdelivr.net/gh/PrivaterVPN/anti-ads@master/singbox-rules/geosite-ads.srs",
        "update_interval": "6h",
        "download_detour": "direct"
      },
      {
        "tag": "geoip-ads",
        "type": "remote",
        "format": "binary",
        "url": "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geo/geoip/ads.srs",
        "update_interval": "12h"
      },

      // ====== 低延迟规则集 ======
      {
        "tag": "geosite-streaming",
        "type": "remote",
        "format": "binary",
        "url": "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geo/geosite/streaming.srs",
        "update_interval": "24h"
      },
      {
        "tag": "geosite-gaming",
        "type": "remote",
        "format": "binary",
        "url": "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geo/geosite/gaming.srs",
        "update_interval": "24h"
      }
    ],
    "final": "🐠 漏网之鱼",
    "auto_detect_interface": true
  },

  "experimental": {
    "cache_file": {
      "enabled": true,
      "path": "/etc/momo/cache_v4.db",
      "cache_id": "v4_${DATE}"
    },
    "clash_api": {
      "external_controller": "0.0.0.0:9090",
      "external_ui": "builtin",
      "update_interval": "24h"
    },
    "v2ray_api": {
      "listen": "127.0.0.1:10085",
      "stats": {
        "inbounds": ["all"],
        "outbounds": ["⚡ 低延迟优选"]
      }
    }
  },

  "ntp": {
    "enabled": true,
    "server": "time.windows.com",
    "server_port": 123,
    "interval": "1h",
    "detour": "direct"
  },

  "log": {
    "level": "info",
    "output": "/var/log/momo/singbox.log",
    "timestamp": true,
    "stacktrace": false
  }
}
